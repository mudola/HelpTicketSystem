{% extends "base.html" %}

{% block title %}Reports - ICT Helpdesk{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2><i class="fas fa-chart-bar me-2"></i>Comprehensive Reports Dashboard</h2>
    <div class="d-flex gap-2 flex-wrap">
        <button onclick="printReport()" class="btn btn-primary">
            <i class="fas fa-print me-1"></i>Print Report
        </button>
        <a href="{{ url_for('reports_pdf', days=days, start_date=start_date, end_date=end_date) }}" target="_blank" class="btn btn-success">
            <i class="fas fa-file-pdf me-1"></i>Export PDF
        </a>
        <button onclick="exportToCSV()" class="btn btn-info">
            <i class="fas fa-file-csv me-1"></i>Export CSV
        </button>
    </div>
</div>

<!-- Enhanced Filters Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Report Filters</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3" id="reportFilterForm">
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <div class="btn-group d-block">
                    <a href="{{ url_for('reports', days=7) }}" class="btn btn-outline-secondary btn-sm {% if days == 7 %}active{% endif %}">7 Days</a>
                    <a href="{{ url_for('reports', days=30) }}" class="btn btn-outline-secondary btn-sm {% if days == 30 %}active{% endif %}">30 Days</a>
                    <a href="{{ url_for('reports', days=90) }}" class="btn btn-outline-secondary btn-sm {% if days == 90 %}active{% endif %}">90 Days</a>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Custom Start Date</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Custom End Date</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="open" {% if status_filter == 'open' %}selected{% endif %}>Open</option>
                    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Resolved</option>
                    <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Closed</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Priority</label>
                <select name="priority" class="form-select">
                    <option value="">All Priorities</option>
                    <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
                    <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
                    <option value="urgent" {% if priority_filter == 'urgent' %}selected{% endif %}>Urgent</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select name="category" class="form-select">
                    <option value="">All Categories</option>
                    {% for category in all_categories %}
                        <option value="{{ category.id }}" {% if category_filter|int == category.id %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select name="department" id="department_filter" class="form-select">
                    <option value="">All Departments</option>
                    <option value="SWA" {% if department_filter == 'SWA' %}selected{% endif %}>SWA</option>
                    <option value="UHS" {% if department_filter == 'UHS' %}selected{% endif %}>UHS</option>
                    <option value="Confucius" {% if department_filter == 'Confucius' %}selected{% endif %}>Confucius</option>
                    <option value="Chiromo" {% if department_filter == 'Chiromo' %}selected{% endif %}>Chiromo</option>
                    <option value="Halls" {% if department_filter == 'Halls' %}selected{% endif %}>Halls</option>
                </select>
            </div>
            <div class="col-md-3" id="subunit-filter-group" style="display:none;">
                <label class="form-label">Subunit</label>
                <select name="subunit" id="subunit_filter" class="form-select">
                    <option value="">Select Subunit</option>
                </select>
            </div>
            <div class="col-md-3" id="location-filter-group" style="display:none;">
                <label class="form-label">Location</label>
                <select name="location" id="location_filter" class="form-select">
                    <option value="">Select Location</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Technician</label>
                <select name="attended_by" class="form-select">
                    <option value="">All Technicians</option>
                    {% for user in all_users %}
                        {% if user.role in ['admin', 'intern'] %}
                            <option value="{{ user.id }}" {% if attended_by|int == user.id %}selected{% endif %}>{{ user.full_name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search me-1"></i>Apply Filters
                </button>
                <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>Clear All
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Key Metrics Cards -->
<div class="row mb-4">
    <div class="col-md-2">
        <a href="{{ url_for('tickets_list') }}" class="text-decoration-none">
            <div class="card text-white bg-primary clickable-card">
                <div class="card-body text-center">
                    <i class="fas fa-ticket-alt fa-2x mb-2"></i>
                    <h4 id="total-tickets">{{ total_tickets }}</h4>
                    <p class="mb-0">Total Tickets</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <a href="{{ url_for('tickets_list', status='open') }}" class="text-decoration-none">
            <div class="card text-white bg-warning clickable-card">
                <div class="card-body text-center">
                    <i class="fas fa-folder-open fa-2x mb-2"></i>
                    <h4 id="open-tickets">{{ open_tickets }}</h4>
                    <p class="mb-0">Open</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <a href="{{ url_for('tickets_list', status='in_progress') }}" class="text-decoration-none">
            <div class="card text-white bg-info clickable-card">
                <div class="card-body text-center">
                    <i class="fas fa-cog fa-2x mb-2"></i>
                    <h4 id="progress-tickets">{{ in_progress_tickets }}</h4>
                    <p class="mb-0">In Progress</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <a href="{{ url_for('tickets_list', status='resolved') }}" class="text-decoration-none">
            <div class="card text-white bg-success clickable-card">
                <div class="card-body text-center">
                    <i class="fas fa-check fa-2x mb-2"></i>
                    <h4 id="resolved-tickets">{{ resolved_tickets }}</h4>
                    <p class="mb-0">Resolved</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <a href="{{ url_for('tickets_list', status='closed') }}" class="text-decoration-none">
            <div class="card text-white bg-secondary clickable-card">
                <div class="card-body text-center">
                    <i class="fas fa-lock fa-2x mb-2"></i>
                    <h4 id="closed-tickets">{{ closed_tickets }}</h4>
                    <p class="mb-0">Closed</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-2">
        <a href="{{ url_for('tickets_list') }}?overdue=true" class="text-decoration-none">
            <div class="card text-white bg-danger clickable-card">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h4 id="overdue-tickets">{{ overdue_tickets|length }}</h4>
                    <p class="mb-0">Overdue</p>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Average Resolution Time Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h3 class="text-primary">
                    {% if avg_resolution_time %}
                        {{ "%.1f"|format(avg_resolution_time) }} hours
                    {% else %}
                        N/A
                    {% endif %}
                </h3>
                <p class="mb-0"><strong>Average Resolution Time</strong></p>
                <small class="text-muted">Based on {{ resolved_tickets + closed_tickets }} resolved/closed tickets</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Status Distribution -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Ticket Status Distribution</h6>
            </div>
            <div class="card-body">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Priority Distribution -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Priority Distribution</h6>
            </div>
            <div class="card-body">
                <canvas id="priorityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Trend Chart -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">7-Day Trend</h6>
            </div>
            <div class="card-body">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Reports Tables -->
<div class="row mb-4">
    <!-- Category Report -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Tickets by Category</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Count</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in category_stats %}
                            <tr>
                                <td>{{ stat.name }}</td>
                                <td>{{ stat.count }}</td>
                                <td>{{ "%.1f"|format((stat.count / total_tickets * 100) if total_tickets > 0 else 0) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Report -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Tickets by Department</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Count</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in department_stats %}
                            <tr>
                                <td>{{ stat.department }}</td>
                                <td>{{ stat.count }}</td>
                                <td>{{ "%.1f"|format((stat.count / total_tickets * 100) if total_tickets > 0 else 0) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Staff Performance -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Staff Performance Report</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Staff Member</th>
                                <th>Role</th>
                                <th>Tickets Handled</th>
                                <th>Avg Resolution Time (Days)</th>
                                <th>Performance Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for staff in staff_performance %}
                            <tr>
                                <td>{{ staff.full_name }}</td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if staff.role == 'admin' else 'warning' }}">
                                        {{ staff.role.title() }}
                                    </span>
                                </td>
                                <td>{{ staff.tickets_handled }}</td>
                                <td>{{ "%.1f"|format(staff.avg_resolution_days or 0) }}</td>
                                <td>
                                    {% set avg_days = staff.avg_resolution_days or 0 %}
                                    {% if avg_days <= 1 %}
                                        <span class="badge bg-success">Excellent</span>
                                    {% elif avg_days <= 2 %}
                                        <span class="badge bg-info">Good</span>
                                    {% elif avg_days <= 3 %}
                                        <span class="badge bg-warning">Average</span>
                                    {% else %}
                                        <span class="badge bg-danger">Needs Improvement</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overdue Tickets -->
{% if overdue_tickets %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Overdue Tickets ({{ overdue_tickets|length }})</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Location</th>
                                <th>Priority</th>
                                <th>Due Date</th>
                                <th>Days Overdue</th>
                                <th>Assignee</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in overdue_tickets %}
                            <tr>
                                <td><a href="{{ url_for('ticket_detail', id=ticket.id) }}">#{{ ticket.id }}</a></td>
                                <td>{{ ticket.location[:30] }}{% if ticket.location|length > 30 %}...{% endif %}</td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if ticket.priority == 'urgent' else 'warning' if ticket.priority == 'high' else 'secondary' }}">
                                        {{ ticket.priority.title() }}
                                    </span>
                                </td>
                                <td>{{ ticket.due_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ (datetime.utcnow() - ticket.due_date).days }}</td>
                                <td>
                                    {% if ticket.assignees %}
                                        {% for assignee in ticket.assignees %}
                                            {{ assignee.full_name }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">Unassigned</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@media print {
    .btn, .navbar, .card-header { display: none !important; }
    .card { border: 1px solid #000 !important; margin-bottom: 20px; }
    body { font-size: 12px; }
}

.clickable-card {
    transition: transform 0.3s ease-in-out;
}

.clickable-card:hover {
    transform: scale(1.05);
}
</style>

<script>
// Status Distribution Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Open', 'In Progress', 'Resolved', 'Closed'],
        datasets: [{
            data: [{{ open_tickets }}, {{ in_progress_tickets }}, {{ resolved_tickets }}, {{ closed_tickets }}],
            backgroundColor: ['#ffc107', '#0dcaf0', '#198754', '#6c757d']
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
    }
});

// Priority Distribution Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d');
new Chart(priorityCtx, {
    type: 'bar',
    data: {
        labels: [{% for stat in priority_stats %}'{{ stat.priority.title() }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Tickets',
            data: [{% for stat in priority_stats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: ['#6c757d', '#ffc107', '#fd7e14', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
    }
});

// Trend Chart
const trendCtx = document.getElementById('trendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: [{% for trend in trend_data %}'{{ trend.date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Tickets Created',
            data: [{% for trend in trend_data %}{{ trend.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
    }
});

function printReport() {
    window.print();
}

function exportToCSV() {
    const data = [
        ['Ticket ID', 'Location', 'Status', 'Priority', 'Category', 'Created', 'Assignee'],
        {% for ticket in tickets %}
        [
            '{{ ticket.id }}',
            '{{ ticket.location|replace("'", "\\'") }}',
            '{{ ticket.status }}',
            '{{ ticket.priority }}',
            '{{ ticket.category.name if ticket.category else "N/A" }}',
            '{{ ticket.created_at.strftime("%Y-%m-%d") }}',
            '{% if ticket.assignees %}{% for assignee in ticket.assignees %}{{ assignee.full_name }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}Unassigned{% endif %}'
        ]{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    const csv = data.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'helpdesk_report_{{ start_date }}_to_{{ end_date }}.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Cascading dropdown functionality
const departmentFilter = document.getElementById('department_filter');
const subunitFilterGroup = document.getElementById('subunit-filter-group');
const subunitFilter = document.getElementById('subunit_filter');
const locationFilterGroup = document.getElementById('location-filter-group');
const locationFilter = document.getElementById('location_filter');

const locationData = {
    'SWA': {
        'USHR': [
            'Hall 4', 'Hall 5', 'Hall 6', 'Hall 7', 'Hall 8', 'Hall 9', 'Swa Headquater', 
            'Mamlaka Unit', 'Procurement', 'Finance Halls', 'Accounts Catering', 'Hall 12', 
            'Hall 13', 'Stella Awinja', 'Womens Hall (Hall 20)', 'Security'
        ],
        'LSHR': [
            'SMU', 'Hall 1', 'Hall 2', 'Hall 3', 'Hall 10', 'Hall 11', 'Hall 15', 
            'Sports department', 'Kitchen 1', 'Internal Audit', 'CCU'
        ]
    },
    'UHS': {
        '': [
            'Staff clinic', 'Student clinic', 'CMO', 'Laboratory', 'SickBay', 
            'ICEC', 'Gender Desk', 'Theatre', 'Accounts'
        ]
    },
    'Confucius': {
        '': [
            'Block A', 'Block B', 'Block C'
        ]
    }
};

function updateSubunitOptions() {
    const department = departmentFilter.value;
    subunitFilter.innerHTML = '<option value="">Select Subunit</option>';
    locationFilter.innerHTML = '<option value="">Select Location</option>';

    if (department === 'SWA') {
        subunitFilterGroup.style.display = '';
        Object.keys(locationData['SWA']).forEach(subunit => {
            const opt = document.createElement('option');
            opt.value = subunit;
            opt.text = subunit;
            subunitFilter.appendChild(opt);
        });
        locationFilterGroup.style.display = 'none';
    } else if (department === 'UHS' || department === 'Confucius') {
        subunitFilterGroup.style.display = 'none';
        locationFilterGroup.style.display = '';
        let locations = locationData[department][''];
        locations.forEach(loc => {
            const opt = document.createElement('option');
            opt.value = loc;
            opt.text = loc;
            locationFilter.appendChild(opt);
        });
    } else {
        subunitFilterGroup.style.display = 'none';
        locationFilterGroup.style.display = 'none';
    }
}

function updateLocationOptions() {
    const department = departmentFilter.value;
    const subunit = subunitFilter.value;
    locationFilter.innerHTML = '<option value="">Select Location</option>';

    if (department === 'SWA' && subunit) {
        locationFilterGroup.style.display = '';
        let locations = locationData['SWA'][subunit] || [];
        locations.forEach(loc => {
            const opt = document.createElement('option');
            opt.value = loc;
            opt.text = loc;
            locationFilter.appendChild(opt);
        });
    } else {
        locationFilterGroup.style.display = 'none';
    }
}

departmentFilter.addEventListener('change', updateSubunitOptions);
subunitFilter.addEventListener('change', updateLocationOptions);

// Initialize on page load
updateSubunitOptions();
</script>
{% endblock %}

<!-- Auto-refresh indicator -->
<div id="refresh-indicator" class="auto-refresh-indicator">
    <i class="fas fa-sync-alt me-2"></i>Updating data...
</div>

{% block extra_js %}
<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Real-time data update functionality
let updateInterval;

function updateTicketCounts() {
    const indicator = document.getElementById('refresh-indicator');
    indicator.classList.add('show');

    fetch('/api/ticket_counts')
        .then(response => response.json())
        .then(data => {
            // Update card counts dynamically
            document.getElementById('total-tickets').textContent = data.total_tickets;
            document.getElementById('open-tickets').textContent = data.open_tickets;
            document.getElementById('progress-tickets').textContent = data.in_progress_tickets;
            document.getElementById('resolved-tickets').textContent = data.resolved_tickets;
            document.getElementById('closed-tickets').textContent = data.closed_tickets;
            document.getElementById('overdue-tickets').textContent = data.overdue_tickets;

            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1500);
        })
        .catch(error => {
            console.error('Error updating ticket counts:', error);
            indicator.classList.remove('show');
        });
}

// Start auto-refresh every 30 seconds
function startAutoRefresh() {
    updateInterval = setInterval(updateTicketCounts, 30000);
}

// Stop auto-refresh
function stopAutoRefresh() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
}

// Print functionality
function printReports() {
    // Add print-specific content
    const printContent = `
        <div class="print-section">
            <h1>ICT Helpdesk - System Reports</h1>
            <p>Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
            <hr>
        </div>
    `;

    // Insert print content at the beginning of the body
    document.body.insertAdjacentHTML('afterbegin', printContent);

    // Print the page
    window.print();

    // Remove print content after printing
    setTimeout(() => {
        const printSections = document.querySelectorAll('.print-section');
        printSections.forEach(section => section.remove());
    }, 1000);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Start auto-refresh
    startAutoRefresh();

    // Stop auto-refresh when user is idle
    let idleTimer;
    function resetIdleTimer() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(stopAutoRefresh, 300000); // Stop after 5 minutes of inactivity
    }

    document.addEventListener('mousemove', resetIdleTimer);
    document.addEventListener('keypress', resetIdleTimer);
    resetIdleTimer();

    // Resume auto-refresh when user becomes active again
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            stopAutoRefresh();
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });

    // Initial update
    updateTicketCounts();
});
</script>
{% endblock %}